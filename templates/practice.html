{% extends "base.html" %}

{% block title %}Practice - {{ content.name }} - TOEFL Listening{% endblock %}

{% block extra_head %}
<style>
    .audio-player {
        background: var(--bs-dark);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .question-card {
        transition: all 0.3s ease;
    }
    .question-card.answered {
        opacity: 0.7;
    }
    .progress-indicator {
        height: 4px;
        background: var(--bs-gray-300);
        border-radius: 2px;
        overflow: hidden;
    }
    .progress-bar-custom {
        height: 100%;
        background: var(--bs-primary);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Audio Player Section -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-headphones me-2"></i>
                        {{ content.description }}
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">{{ content.name }}</span>
                        <span class="badge bg-primary">{{ content.difficulty_level }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body audio-player">
                <!-- Audio Player Controls -->
                <div class="audio-controls mb-3">
                    {% if content.type == 'ai_tpo_practice' %}
                    <!-- AI Text-to-Speech Player (without comments) -->
                    <div class="ai-tts-player border rounded p-3 mb-3" style="background: #1a1a1a;">
                        <div class="d-flex align-items-center gap-2">
                            <button id="tts-play-btn" class="btn btn-success">
                                <i class="fas fa-play me-2"></i>Play Audio Content
                            </button>
                            <button id="tts-pause-btn" class="btn btn-warning" style="display: none;">
                                <i class="fas fa-pause me-2"></i>Pause
                            </button>
                            <button id="tts-stop-btn" class="btn btn-danger" style="display: none;">
                                <i class="fas fa-stop me-2"></i>Stop
                            </button>
                            <div class="ms-auto text-white">
                                <small id="tts-status">Ready to play content</small>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Standard Audio Player for non-AI content -->
                    <audio id="audio-player" controls class="w-100" preload="metadata">
                        <source src="{{ content.url }}" type="audio/mpeg">
                        <p>Your browser does not support the audio element.</p>
                    </audio>
                    {% endif %}
                </div>
                
                <!-- Player Controls -->
                <div class="d-flex justify-content-between align-items-center">
                    <div class="audio-info">
                        <span id="current-time">0:00</span> / <span id="duration">--:--</span>
                    </div>
                    <div class="audio-speed">
                        <label for="speed-control" class="form-label mb-0 me-2">Speed:</label>
                        <select id="speed-control" class="form-select form-select-sm" style="width: auto;">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                        </select>
                    </div>
                    <div class="audio-actions">
                        <button id="replay-10" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-undo me-1"></i>-10s
                        </button>
                        <button id="forward-10" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-redo me-1"></i>+10s
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Session Info -->
    <div class="col-12 mb-4">
        <div class="card bg-info">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="text-white mb-2">Practice Session Progress</h6>
                        <div class="progress-indicator">
                            <div class="progress-bar-custom" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end text-white">
                        <span id="question-counter">0 / {{ questions|length }}</span> Questions
                        <br>
                        <small>Time: <span id="session-timer">00:00</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Section (Hidden until audio ends) -->
    <div class="col-lg-8">
        <!-- Audio Instructions -->
        <div id="audio-instructions" class="card border-info mb-4">
            <div class="card-body text-center">
                <i class="fas fa-headphones fa-3x text-info mb-3"></i>
                <h5>Listen to the audio first</h5>
                <p class="text-muted">Please listen to the complete audio before answering questions. Questions will appear after the audio finishes.</p>
                <div class="spinner-border text-info" role="status" id="listening-spinner">
                    <span class="visually-hidden">Listening...</span>
                </div>
            </div>
        </div>
        
        <div id="questions-container" style="display: none;">
            {% for question in questions %}
            <div class="card question-card mb-4" id="question-{{ loop.index }}" style="{% if loop.index > 1 %}display: none;{% endif %}">
                <div class="card-header">
                    <h6 class="mb-0">
                        Question {{ loop.index }} of {{ questions|length }}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="question-text">{{ question.question_text }}</p>
                    
                    <!-- TOEFL-style questions with single and multiple select -->
                    {% if question.options %}
                    <div class="options-container">
                        {% if question.question_type == 'multiple_select' %}
                            <!-- Multi-select questions -->
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>
                                    {% set correct_count = question.correct_answer.split(',') | length %}
                                    Choose {{ correct_count }} answer{{ 's' if correct_count > 1 else '' }}.
                                </strong>
                                <small class="d-block mt-1">This question requires exactly {{ correct_count }} correct selection{{ 's' if correct_count > 1 else '' }}.</small>
                            </div>
                            {% for option in question.options %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" 
                                       name="question_{{ loop.index0 }}" 
                                       id="q{{ loop.index0 }}_option{{ loop.index }}" 
                                       value="{{ option }}">
                                <label class="form-check-label" for="q{{ loop.index0 }}_option{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Single-select questions -->
                            {% for option in question.options %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" 
                                       name="question_{{ loop.index0 }}" 
                                       id="q{{ loop.index0 }}_option{{ loop.index }}" 
                                       value="{{ option }}">
                                <label class="form-check-label" for="q{{ loop.index0 }}_option{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% elif question.question_type == 'multiple_answer' %}
                    <div class="options-container">
                        <!-- Multiple Answer Selection Instruction -->
                        {% if question.correct_answer and ',' in question.correct_answer %}
                            {% set correct_count = question.correct_answer.split(',') | length %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-check-square me-2"></i>
                                <strong>Choose {{ correct_count }} answer{{ 's' if correct_count > 1 else '' }}.</strong>
                                <small class="d-block mt-1">Select exactly {{ correct_count }} option{{ 's' if correct_count > 1 else '' }} for this question.</small>
                            </div>
                        {% else %}
                            <!-- Fallback: extract from question text -->
                            {% if 'Choose 2' in question.question_text %}
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-check-square me-2"></i>
                                    <strong>Choose 2 answers.</strong>
                                    <small class="d-block mt-1">Select exactly 2 options for this question.</small>
                                </div>
                            {% elif 'Choose 3' in question.question_text %}
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-check-square me-2"></i>
                                    <strong>Choose 3 answers.</strong>
                                    <small class="d-block mt-1">Select exactly 3 options for this question.</small>
                                </div>
                            {% else %}
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-check-square me-2"></i>
                                    <strong>Multiple answers required.</strong>
                                    <small class="d-block mt-1">Select multiple options for this question.</small>
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        {% for option in question.options %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" 
                                   name="question_{{ loop.index0 }}" 
                                   id="q{{ loop.index0 }}_option{{ loop.index }}" 
                                   value="{{ option }}">
                            <label class="form-check-label" for="q{{ loop.index0 }}_option{{ loop.index }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <textarea class="form-control" rows="3" 
                                  name="question_{{ loop.index0 }}" 
                                  placeholder="Type your answer here..."></textarea>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        {% if loop.index > 1 %}
                        <button class="btn btn-outline-secondary" onclick="previousQuestion()">
                            <i class="fas fa-arrow-left me-1"></i>Previous
                        </button>
                        {% else %}
                        <div></div>
                        {% endif %}
                        
                        <button class="btn btn-primary" onclick="submitAnswer({{ loop.index }}, {{ question.id }})">
                            {% if loop.index == questions|length %}
                            <i class="fas fa-check me-1"></i>Finish
                            {% else %}
                            <i class="fas fa-arrow-right me-1"></i>Next
                            {% endif %}
                        </button>
                    </div>
                    
                    <!-- Answer feedback (hidden initially) -->
                    <div class="answer-feedback mt-3" style="display: none;">
                        <div class="alert" role="alert">
                            <h6 class="alert-heading"></h6>
                            <p class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Navigation Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>Question Navigation
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2" id="question-nav">
                    {% for question in questions %}
                    <div class="col-3">
                        <button class="btn btn-outline-secondary btn-sm w-100 question-nav-btn" 
                                data-question="{{ loop.index }}"
                                onclick="goToQuestion({{ loop.index }})">
                            {{ loop.index }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Instructions
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-play text-primary me-2"></i>
                        Listen to the audio carefully
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-redo text-success me-2"></i>
                        You can replay sections as needed
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-clock text-warning me-2"></i>
                        Take your time with each question
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-info me-2"></i>
                        Review your answers before finishing
                    </li>
                </ul>
            </div>
        </div>

        <!-- Session Stats -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Session Stats
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary mb-0" id="correct-count">0</h4>
                        <small class="text-muted">Correct</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-danger mb-0" id="incorrect-count">0</h4>
                        <small class="text-muted">Incorrect</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for session data -->
<form id="session-form" style="display: none;">
    <input type="hidden" name="session_id" value="{{ session_id }}">
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/audio_player.js') }}"></script>
<script src="{{ url_for('static', filename='js/practice.js') }}"></script>
{% if content.type == 'ai_tpo_practice' %}
<script src="{{ url_for('static', filename='js/web-tts-player.js') }}"></script>
{% endif %}
<script>
    // Initialize practice session
    const sessionData = {
        sessionId: {{ session_id }},
        totalQuestions: {{ questions|length }},
        questions: {{ questions_data|tojson }},
        currentQuestion: 1,
        answers: {},
        startTime: new Date(),
        correctCount: 0,
        incorrectCount: 0,
        audioFinished: false
    };
    
    // Answer timing functions
    var answerStartTime = null;
    var answerTimerInterval = null;
    
    function startAnswerTimer() {
        answerStartTime = Date.now();
        updateAnswerTimer();
    }
    
    function updateAnswerTimer() {
        const timerElement = document.getElementById('session-timer');
        if (timerElement && answerStartTime) {
            const elapsed = Math.floor((Date.now() - answerStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            answerTimerInterval = setTimeout(updateAnswerTimer, 1000);
        }
    }
    
    function stopAnswerTimer() {
        if (answerTimerInterval) {
            clearTimeout(answerTimerInterval);
            answerTimerInterval = null;
        }
    }

    // Audio flow control
    function showQuestionsAfterAudio() {
        const audioInstructions = document.getElementById('audio-instructions');
        const questionsContainer = document.getElementById('questions-container');
        const listeningSpinner = document.getElementById('listening-spinner');
        const audioPlayer = document.querySelector('.card.border-primary');
        
        if (audioInstructions) audioInstructions.style.display = 'none';
        if (questionsContainer) questionsContainer.style.display = 'block';
        if (listeningSpinner) listeningSpinner.style.display = 'none';
        
        // Hide audio player completely after questions appear
        if (audioPlayer) audioPlayer.style.display = 'none';
        
        // Start answer timer when questions appear
        startAnswerTimer();
        
        sessionData.audioFinished = true;
        // Initialize practice session and show first question
        if (typeof initializePracticeSession === 'function') {
            initializePracticeSession(sessionData);
        } else if (typeof goToQuestion === 'function') {
            goToQuestion(1);
        } else {
            // Fallback: show first question manually
            const firstQuestion = document.querySelector('.question-card');
            if (firstQuestion) firstQuestion.style.display = 'block';
        }
    }
    
    
    {% if content.type == 'ai_tpo_practice' %}
    // Initialize AI TTS Player for AI content
    function initializeAITTS() {
        const ttsPlayBtn = document.getElementById('tts-play-btn');
        const ttsPauseBtn = document.getElementById('tts-pause-btn');
        const ttsStopBtn = document.getElementById('tts-stop-btn');
        const ttsStatus = document.getElementById('tts-status');
        
        
        // Load AI text content
        fetch('/static/ai_audio/text_content.json')
            .then(response => response.json())
            .then(data => {
                console.log('AI content data loaded:', Object.keys(data).length, 'items');
                const contentUrl = '{{ content.url }}';
                console.log('Looking for content URL:', contentUrl);
                
                // Try to find the matching content by URL filename
                const filename = contentUrl.split('/').pop();
                console.log('Extracted filename:', filename);
                
                let contentData = data[filename];
                
                // If not found by exact filename, try to find by content ID or similar pattern
                if (!contentData) {
                    console.log('Exact filename not found, searching by patterns...');
                    const contentId = {{ content.id }};
                    
                    // Look for content that matches patterns like tpo_1_lec_1.mp3
                    for (const [key, value] of Object.entries(data)) {
                        if (key.includes('tpo_1_lec') || key.includes('tpo_1_conv')) {
                            contentData = value;
                            console.log('Found matching content:', key);
                            break;
                        }
                    }
                }
                
                if (contentData && contentData.text) {
                    console.log('Content found:', contentData.title);
                    let fullText = contentData.text;
                    
                    // Convert Chinese content to English for better TTS support
                    if (fullText.includes('財務援助')) {
                        fullText = `Welcome to this TOEFL listening practice session. Today we have a campus conversation about financial aid and scholarships. Student: Hello, I would like to ask about financial aid and scholarship opportunities. Staff: Of course, I'd be happy to help you. Please tell me about your specific situation. Student: I'm having some difficulties with financial aid and scholarships. Staff: I understand your concerns. Let me explain this in detail for you. This conversation will cover various aspects of financial assistance available to students, including federal grants, merit-based scholarships, work-study programs, and loan options. We'll also discuss application deadlines, eligibility requirements, and tips for successful applications.`;
                    } else if (fullText.includes('經濟政策')) {
                        // Use the complete transcript from database for Economic Policy
                        const dbTranscript = `{{ content.content_metadata.transcript | replace('"', '\"') | safe }}`;
                        if (dbTranscript && dbTranscript.length > 1000) {
                            fullText = dbTranscript;
                            console.log('Using complete database transcript, length:', fullText.length);
                        } else {
                            fullText = `Welcome to today's economics lecture on economic policy. Economic policy refers to the actions that governments take in the economic field. This includes monetary policy, fiscal policy, trade policy, and regulatory frameworks. Today we will examine how these policies affect economic growth, inflation, unemployment, and overall economic stability. We'll also discuss the role of central banks, government spending decisions, and how different economic theories influence policy making. Understanding economic policy is crucial for students as it affects every aspect of our daily lives and business decisions.`;
                        }
                    } else if (fullText.includes('社會學')) {
                        fullText = `Today's sociology lecture focuses on fundamental concepts in social research. Sociology is the scientific study of society, social relationships, and social behavior. We'll explore key research methodologies including surveys, interviews, participant observation, and statistical analysis. This lecture covers theoretical frameworks such as functionalism, conflict theory, and symbolic interactionism. We'll examine how sociologists study social institutions, social change, and the relationship between individual behavior and larger social forces.`;
                    } else {
                        // Generic academic content if not specifically matched
                        fullText = `Welcome to this academic lecture. Today we will explore important concepts and theories that are fundamental to understanding this subject area. This presentation will cover key principles, examine real-world applications, and discuss current research findings. We'll analyze different perspectives and methodologies used in this field of study. Please listen carefully as this material will help you understand the broader context and significance of these academic concepts.`;
                    }
                    
                    // Store the text globally for TTS
                    window.aiContentText = fullText;
                    
                    // TTS controls
                    ttsPlayBtn.addEventListener('click', function() {
                        console.log('TTS Play button clicked');
                        if (!window.speechSynthesis) {
                            alert('Text-to-speech not supported in this browser');
                            return;
                        }
                        
                        console.log('Speech synthesis available');
                        
                        ttsStatus.textContent = 'Playing AI academic content...';
                        ttsPlayBtn.style.display = 'none';
                        ttsPauseBtn.style.display = 'inline-block';
                        ttsStopBtn.style.display = 'inline-block';
                        
                        // Create and configure multi-voice speech
                        const textToSpeak = window.aiContentText || fullText || contentData.text;
                        console.log('Starting multi-voice TTS for text length:', textToSpeak.length);
                        
                        // Use multi-voice TTS function
                        playMultiVoiceTTS(textToSpeak, ttsStatus, ttsPlayBtn, ttsPauseBtn, ttsStopBtn);
                        return;
                        
                        // Calculate estimated duration (approximately 150-200 words per minute)
                        const wordCount = textToSpeak.split(' ').length;
                        const estimatedDuration = Math.round((wordCount / 150) * 60); // seconds
                        let currentTime = 0;
                        let timeInterval;
                        
                        console.log('Estimated duration:', estimatedDuration, 'seconds for', wordCount, 'words');
                        
                        // Select and configure voice
                        const voices = speechSynthesis.getVoices();
                        console.log('Available voices:', voices.length);
                        
                        // Try to find a good English voice
                        let selectedVoice = voices.find(voice => 
                            voice.lang.includes('en-US') && 
                            voice.name.includes('Female')
                        );
                        
                        if (!selectedVoice) {
                            selectedVoice = voices.find(voice => voice.lang.includes('en'));
                        }
                        
                        if (!selectedVoice && voices.length > 0) {
                            selectedVoice = voices[0];
                        }
                        
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                            console.log('Selected voice:', selectedVoice.name, selectedVoice.lang);
                        } else {
                            console.log('No suitable voice found, using default');
                        }
                        
                        utterance.onstart = function() {
                            console.log('AI TTS started successfully');
                            ttsStatus.textContent = 'Playing academic content...';
                            
                            // Start time counter
                            const currentTimeSpan = document.getElementById('current-time');
                            const durationSpan = document.getElementById('duration');
                            
                            console.log('Setting up time display, estimated duration:', estimatedDuration);
                            
                            if (durationSpan) {
                                const minutes = Math.floor(estimatedDuration / 60);
                                const seconds = estimatedDuration % 60;
                                durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                console.log('Duration set to:', durationSpan.textContent);
                            }
                            
                            if (currentTimeSpan) {
                                currentTime = 0;
                                timeInterval = setInterval(function() {
                                    currentTime++;
                                    const minutes = Math.floor(currentTime / 60);
                                    const seconds = currentTime % 60;
                                    currentTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                    
                                    // Stop when estimated duration is reached
                                    if (currentTime >= estimatedDuration) {
                                        clearInterval(timeInterval);
                                    }
                                }, 1000);
                            }
                        };
                        
                        utterance.onend = function() {
                            ttsStatus.textContent = 'Content finished';
                            ttsPlayBtn.style.display = 'inline-block';
                            ttsPauseBtn.style.display = 'none';
                            ttsStopBtn.style.display = 'none';
                            
                            // Clear time interval
                            if (timeInterval) {
                                clearInterval(timeInterval);
                            }
                            
                            // Show questions after audio ends
                            showQuestionsAfterAudio();
                        };
                        
                        utterance.onerror = function(event) {
                            console.error('TTS error:', event.error);
                            ttsStatus.textContent = 'Playback error: ' + event.error;
                            ttsPlayBtn.style.display = 'inline-block';
                            ttsPauseBtn.style.display = 'none';
                            ttsStopBtn.style.display = 'none';
                            
                            // Clear time interval
                            if (timeInterval) {
                                clearInterval(timeInterval);
                            }
                        };
                        
                        // Store utterance globally for stop/pause functions
                        window.currentUtterance = utterance;
                        
                        // Ensure voices are loaded before speaking
                        if (voices.length === 0) {
                            console.log('No voices loaded yet, waiting...');
                            speechSynthesis.onvoiceschanged = function() {
                                console.log('Voices loaded, now speaking');
                                speechSynthesis.speak(utterance);
                            };
                        } else {
                            console.log('Speaking utterance now with voice:', utterance.voice ? utterance.voice.name : 'default');
                            
                            // Stop any existing speech first
                            speechSynthesis.cancel();
                            
                            // Small delay to ensure cleanup
                            setTimeout(function() {
                                speechSynthesis.speak(utterance);
                            }, 100);
                        }
                    });
                    
                    ttsPauseBtn.addEventListener('click', function() {
                        speechSynthesis.pause();
                        ttsStatus.textContent = 'Paused';
                    });
                    
                    ttsStopBtn.addEventListener('click', function() {
                        speechSynthesis.cancel();
                        ttsStatus.textContent = 'Stopped';
                        ttsPlayBtn.style.display = 'inline-block';
                        ttsPauseBtn.style.display = 'none';
                        ttsStopBtn.style.display = 'none';
                        
                        // Clear time interval and reset time
                        if (timeInterval) {
                            clearInterval(timeInterval);
                        }
                        const currentTimeSpan = document.getElementById('current-time');
                        if (currentTimeSpan) {
                            currentTimeSpan.textContent = '0:00';
                        }
                    });
                    
                } else {
                    console.log('No matching content found, using database transcript');
                    // Use database transcript as priority
                    const dbTranscript = `{{ content_transcript|replace('"', '\\"')|safe }}`;
                    if (dbTranscript && dbTranscript.length > 1000 && !dbTranscript.includes('undefined')) {
                        window.aiContentText = dbTranscript;
                        console.log('Using complete database transcript, length:', dbTranscript.length);
                    } else {
                        // Fallback content for demonstration
                        const fallbackText = `Welcome to this TOEFL listening practice session. Today we will discuss economic policy, which is a fundamental concept in economics. Economic policy refers to the actions that governments take in the economic field. This includes taxation, government spending, monetary policy, and regulations. Understanding economic policy is crucial for students of economics as it affects every aspect of our daily lives. Let's explore the key principles and applications of economic policy in modern society.`;
                        window.aiContentText = fallbackText;
                        console.log('Using fallback content for TTS');
                    }
                }
            })
            .catch(error => {
                console.error('Error loading AI content:', error);
                // Use fallback content
                const fallbackText = `Welcome to this TOEFL listening practice session. Today we will discuss economic policy, which is a fundamental concept in economics.`;
                window.aiContentText = fallbackText;
                ttsPlayBtn.disabled = true;
            });
    }
    
    // Function to parse transcript into speaker segments
    function parseTranscriptIntoSegments(text) {
        const segments = [];
        const lines = text.split('\n\n');
        
        // Track previous student speakers to assign voices consistently
        let lastStudentSpeakers = [];
        
        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            
            // Identify specific speaker based on content and context
            let speaker = 'professor'; // default
            
            // Check for student response patterns
            if (line.includes('Professor,') || 
                line.match(/^(Well|Um|I guess|I think|I was wondering|Because)/)) {
                
                // Identify specific students based on question content and position
                if (line.includes('Professor, I was wondering')) {
                    speaker = 'jessica'; // Jessica asks about policy decisions
                } else if (line.includes('Professor, because') && line.includes('trade off')) {
                    speaker = 'emma'; // Emma explains Keynesian theory
                } else if (line.includes('taxes on coffee') || line.includes('minimum wage')) {
                    speaker = 'sarah'; // Sarah talks about coffee and wages
                } else if (line.includes('student loan') || line.includes('grants')) {
                    speaker = 'michael'; // Michael mentions student loans
                } else if (line.includes('stimulus checks') || line.includes('refinance')) {
                    speaker = 'david'; // David talks about COVID and housing
                } else {
                    // Assign based on position in conversation
                    if (lastStudentSpeakers.length === 0) speaker = 'sarah';
                    else if (lastStudentSpeakers.length === 1) speaker = 'michael';
                    else if (lastStudentSpeakers.length === 2) speaker = 'jessica';
                    else if (lastStudentSpeakers.length === 3) speaker = 'david';
                    else speaker = 'emma';
                }
                
                if (!lastStudentSpeakers.includes(speaker)) {
                    lastStudentSpeakers.push(speaker);
                }
            }
            
            segments.push({
                text: line,
                speaker: speaker
            });
        }
        
        return segments;
    }
    
    // Function to play multi-voice TTS
    function playMultiVoiceTTS(fullText, statusElement, playBtn, pauseBtn, stopBtn) {
        const segments = parseTranscriptIntoSegments(fullText);
        let currentSegment = 0;
        let isPaused = false;
        let currentUtterance = null;
        
        // Get available voices and assign unique voice to each person
        const voices = speechSynthesis.getVoices();
        
        // Professor - authoritative male voice
        const professorVoice = voices.find(voice => voice.name.includes('Mark') && voice.lang.includes('en-US')) ||
                              voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Male')) ||
                              voices.find(voice => voice.lang.includes('en-US')) ||
                              voices[0];
        
        // Female students - different female voices
        const jessicaVoice = voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Zira')) ||
                            voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Female')) ||
                            professorVoice;
        
        const emmaVoice = voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Hazel')) ||
                         voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Linda')) ||
                         voices.find(voice => voice.lang.includes('en') && voice.name.includes('Female')) ||
                         jessicaVoice;
        
        const sarahVoice = voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Eva')) ||
                          voices.find(voice => voice.lang.includes('en-GB') && voice.name.includes('Female')) ||
                          voices.find(voice => voice.lang.includes('en-AU') && voice.name.includes('Female')) ||
                          emmaVoice;
        
        // Male students - different male voices  
        const michaelVoice = voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('David') && !voice.name.includes('Mark')) ||
                            voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('Male') && !voice.name.includes('Mark')) ||
                            professorVoice;
        
        const davidVoice = voices.find(voice => voice.lang.includes('en-US') && voice.name.includes('George')) ||
                          voices.find(voice => voice.lang.includes('en-GB') && voice.name.includes('Male')) ||
                          voices.find(voice => voice.lang.includes('en-AU') && voice.name.includes('Male')) ||
                          michaelVoice;
        
        const voiceMap = {
            professor: professorVoice,
            jessica: jessicaVoice,
            emma: emmaVoice,
            sarah: sarahVoice,
            michael: michaelVoice,
            david: davidVoice
        };
        
        console.log('Individual voice assignments:', {
            professor: professorVoice?.name,
            jessica: jessicaVoice?.name,
            emma: emmaVoice?.name,
            sarah: sarahVoice?.name,
            michael: michaelVoice?.name,
            david: davidVoice?.name
        });
        
        function playNextSegment() {
            if (currentSegment >= segments.length || isPaused) {
                if (currentSegment >= segments.length) {
                    console.log('Multi-voice TTS playback finished');
                    statusElement.textContent = 'Content finished';
                    playBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                    stopAudioTimer();
                    showQuestionsAfterAudio();
                }
                return;
            }
            
            const segment = segments[currentSegment];
            currentUtterance = new SpeechSynthesisUtterance(segment.text);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;
            
            // Select individual voice and characteristics for each person
            const selectedVoice = voiceMap[segment.speaker] || voiceMap.professor;
            currentUtterance.voice = selectedVoice;
            
            // Assign unique voice characteristics for each person
            switch (segment.speaker) {
                case 'professor':
                    currentUtterance.pitch = 0.8; // Lower pitch for authority
                    currentUtterance.rate = 0.85; // Slower, more deliberate
                    break;
                case 'jessica':
                    currentUtterance.pitch = 1.3; // Higher female voice
                    currentUtterance.rate = 0.95; // Thoughtful pace
                    break;
                case 'emma':
                    currentUtterance.pitch = 1.4; // Highest female voice
                    currentUtterance.rate = 1.0; // Confident pace
                    break;
                case 'sarah':
                    currentUtterance.pitch = 1.2; // Medium female voice
                    currentUtterance.rate = 0.9; // Careful pace
                    break;
                case 'michael':
                    currentUtterance.pitch = 1.1; // Young male voice
                    currentUtterance.rate = 0.95; // Energetic pace
                    break;
                case 'david':
                    currentUtterance.pitch = 1.0; // Deeper male student voice
                    currentUtterance.rate = 1.0; // Casual pace
                    break;
                default:
                    currentUtterance.pitch = 1.0;
                    currentUtterance.rate = 0.9;
                    break;
            }
            
            currentUtterance.onend = function() {
                currentSegment++;
                setTimeout(playNextSegment, 300); // Small pause between speakers
            };
            
            currentUtterance.onerror = function(event) {
                console.error('TTS error in segment', currentSegment, ':', event.error);
                currentSegment++;
                setTimeout(playNextSegment, 100);
            };
            
            speechSynthesis.speak(currentUtterance);
            console.log('Playing segment', currentSegment + 1, 'of', segments.length, 'with', segment.speaker, 'voice:', selectedVoice?.name);
        }
        
        // Set up controls
        statusElement.textContent = 'Playing multi-voice academic content...';
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-block';
        stopBtn.style.display = 'inline-block';
        
        // Start playback and timer
        startAudioTimer();
        playNextSegment();
        
        // Audio timer functions
        function startAudioTimer() {
            const currentTimeSpan = document.getElementById('current-time');
            if (currentTimeSpan && !window.audioTimeInterval) {
                let audioCurrentTime = 0;
                window.audioTimeInterval = setInterval(function() {
                    if (!isPaused) {
                        audioCurrentTime++;
                        const minutes = Math.floor(audioCurrentTime / 60);
                        const seconds = audioCurrentTime % 60;
                        currentTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
        }
        
        function stopAudioTimer() {
            if (window.audioTimeInterval) {
                clearInterval(window.audioTimeInterval);
                window.audioTimeInterval = null;
            }
        }
        
        // Override pause button for multi-voice
        pauseBtn.onclick = function() {
            if (!isPaused) {
                isPaused = true;
                speechSynthesis.cancel();
                console.log('Pausing TTS playback at segment', currentSegment + 1);
                statusElement.textContent = 'Paused - Click Play to continue';
                playBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
        };
        
        // Override play button for resume
        playBtn.onclick = function() {
            if (isPaused) {
                isPaused = false;
                console.log('Resuming TTS playback from segment', currentSegment + 1);
                statusElement.textContent = 'Playing multi-voice academic content...';
                playBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                playNextSegment(); // Will continue from current segment
            } else {
                // Initial play - start from beginning
                currentSegment = 0;
                isPaused = false;
                playNextSegment();
            }
        };
        
        // Override stop button
        stopBtn.onclick = function() {
            isPaused = true;
            currentSegment = segments.length; // End playback
            speechSynthesis.cancel();
            statusElement.textContent = 'Stopped';
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
        };
    }

    // Function to set up TTS controls with content
    function setupTTSControls() {
        const ttsPlayBtn = document.getElementById('tts-play-btn');
        const ttsPauseBtn = document.getElementById('tts-pause-btn');
        const ttsStopBtn = document.getElementById('tts-stop-btn');
        const ttsStatus = document.getElementById('tts-status');
        
        // Remove any existing event listeners to prevent duplicates
        const newPlayBtn = ttsPlayBtn.cloneNode(true);
        ttsPlayBtn.parentNode.replaceChild(newPlayBtn, ttsPlayBtn);
        const newPauseBtn = ttsPauseBtn.cloneNode(true);
        ttsPauseBtn.parentNode.replaceChild(newPauseBtn, ttsPauseBtn);
        const newStopBtn = ttsStopBtn.cloneNode(true);
        ttsStopBtn.parentNode.replaceChild(newStopBtn, ttsStopBtn);
        
        newPlayBtn.addEventListener('click', function() {
            // Check if we're resuming from pause first
            if (speechSynthesis.paused) {
                console.log('Resuming from pause');
                speechSynthesis.resume();
                ttsStatus.textContent = 'Playing academic content...';
                newPlayBtn.style.display = 'none';
                newPauseBtn.style.display = 'inline-block';
                return;
            }
            console.log('TTS Play button clicked');
            if (!window.speechSynthesis) {
                alert('Text-to-speech not supported in this browser');
                return;
            }
            
            console.log('Speech synthesis available');
            
            ttsStatus.textContent = 'Playing AI academic content...';
            ttsPlayBtn.style.display = 'none';
            ttsPauseBtn.style.display = 'inline-block';
            ttsStopBtn.style.display = 'inline-block';
            
            // Use the stored text content with multi-voice
            const fullText = window.aiContentText;
            console.log('Starting multi-voice TTS for text length:', fullText.length);
            
            // Use multi-voice TTS function
            playMultiVoiceTTS(fullText, ttsStatus, newPlayBtn, newPauseBtn, newStopBtn);
            return;
            
            // Calculate estimated duration
            const wordCount = textToSpeak.split(' ').length;
            const estimatedDuration = Math.round((wordCount / 150) * 60);
            let currentTime = 0;
            let timeInterval;
            
            console.log('Estimated duration:', estimatedDuration, 'seconds for', wordCount, 'words');
            
            // Select voice
            const voices = speechSynthesis.getVoices();
            console.log('Available voices:', voices.length);
            let selectedVoice = null;
            for (let i = 0; i < voices.length; i++) {
                if (voices[i].name.includes('Mark') && voices[i].lang.includes('en-US')) {
                    selectedVoice = voices[i];
                    break;
                }
            }
            if (selectedVoice) {
                utterance.voice = selectedVoice;
                console.log('Selected voice:', selectedVoice.name, selectedVoice.lang);
            }
            
            utterance.onstart = function() {
                console.log('AI TTS started successfully - audio is now playing');
                ttsStatus.textContent = 'Playing academic content...';
                newPlayBtn.style.display = 'none';
                newPauseBtn.style.display = 'inline-block';
                newStopBtn.style.display = 'inline-block';
                
                const currentTimeSpan = document.getElementById('current-time');
                const durationSpan = document.getElementById('duration');
                
                console.log('Setting up time display, estimated duration:', estimatedDuration);
                
                if (durationSpan) {
                    const minutes = Math.floor(estimatedDuration / 60);
                    const seconds = estimatedDuration % 60;
                    durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    console.log('Duration set to:', durationSpan.textContent);
                }
                
                if (currentTimeSpan) {
                    currentTime = 0;
                    currentTimeSpan.textContent = '0:00';
                    timeInterval = setInterval(function() {
                        currentTime++;
                        const minutes = Math.floor(currentTime / 60);
                        const seconds = currentTime % 60;
                        currentTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        if (currentTime >= estimatedDuration) {
                            clearInterval(timeInterval);
                        }
                    }, 1000);
                }
            };
            
            utterance.onend = function() {
                console.log('TTS playback finished');
                ttsStatus.textContent = 'Content finished';
                newPlayBtn.style.display = 'inline-block';
                newPauseBtn.style.display = 'none';
                newStopBtn.style.display = 'none';
                
                if (timeInterval) {
                    clearInterval(timeInterval);
                }
                
                // Show questions after audio ends
                showQuestionsAfterAudio();
            };
            
            utterance.onerror = function(event) {
                console.error('TTS error:', event.error);
                ttsStatus.textContent = 'Playback error: ' + event.error;
                newPlayBtn.style.display = 'inline-block';
                newPauseBtn.style.display = 'none';
                newStopBtn.style.display = 'none';
                
                if (timeInterval) {
                    clearInterval(timeInterval);
                }
            };
            
            // Ensure voices are loaded before speaking
            if (voices.length === 0) {
                console.log('No voices loaded yet, waiting...');
                speechSynthesis.onvoiceschanged = function() {
                    console.log('Voices loaded, now speaking');
                    speechSynthesis.speak(utterance);
                };
            } else {
                console.log('Speaking utterance now with voice:', utterance.voice ? utterance.voice.name : 'default');
                
                // Stop any existing speech first
                speechSynthesis.cancel();
                
                // Small delay to ensure cleanup
                setTimeout(function() {
                    speechSynthesis.speak(utterance);
                }, 100);
            }
        });
        
        newPauseBtn.addEventListener('click', function() {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                console.log('Pausing TTS playback');
                speechSynthesis.pause();
                ttsStatus.textContent = 'Paused - Click Play to continue';
                newPlayBtn.style.display = 'inline-block';
                newPauseBtn.style.display = 'none';
            }
        });
        
        newStopBtn.addEventListener('click', function() {
            speechSynthesis.cancel();
            ttsStatus.textContent = 'Stopped';
            newPlayBtn.style.display = 'inline-block';
            newPauseBtn.style.display = 'none';
            newStopBtn.style.display = 'none';
            
            // Clear time interval and reset time
            const currentTimeSpan = document.getElementById('current-time');
            if (currentTimeSpan) {
                currentTimeSpan.textContent = '0:00';
            }
        });
    }
    
    // Initialize with database transcript first
    function initializeContent() {
        const dbTranscript = `{{ content_transcript|replace('"', '\\"')|safe }}`;
        
        if (dbTranscript && dbTranscript.length > 1000 && !dbTranscript.includes('undefined')) {
            window.aiContentText = dbTranscript;
            console.log('Using complete database transcript, length:', dbTranscript.length);
            
            // Calculate and set initial duration display
            const wordCount = dbTranscript.split(' ').length;
            const estimatedSeconds = Math.round((wordCount / 150) * 60);
            const minutes = Math.floor(estimatedSeconds / 60);
            const seconds = estimatedSeconds % 60;
            const durationSpan = document.getElementById('duration');
            if (durationSpan) {
                durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                console.log('Initial duration display set to:', durationSpan.textContent, 'based on', wordCount, 'words');
            }
            
            setupTTSControls();
        } else {
            console.log('Database transcript not available, initializing standard TTS');
            initializeAITTS();
        }
    }
    
    // Initialize content after page loads
    setTimeout(initializeContent, 1000);
    {% else %}
    // Initialize standard audio player
    initializeAudioPlayer();
    {% endif %}
    
    // Only initialize practice session after audio ends (it will be done in showQuestionsAfterAudio)
</script>
{% endblock %}
