{% extends "base.html" %}

{% block title %}Listen & Practice - {{ edition.title }} - TOEFL Listening Practice{% endblock %}

{% block content %}
<!-- Edition Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-headphones me-2"></i>
                    {{ edition.title }}
                </h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar me-1"></i>{{ edition.date.strftime('%B %d, %Y') }} | 
                    <i class="fas fa-clock me-1"></i>{{ "%.1f"|format(edition.total_duration_sec/3600) }} hours |
                    <i class="fas fa-list me-1"></i>{{ segments|length }} segments
                </p>
            </div>
            <div>
                <a href="{{ url_for('daily_news_area') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Daily News
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Audio Player Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle me-2"></i>Audio Player
                </h5>
            </div>
            <div class="card-body">
                <!-- Audio Element -->
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Text-to-Speech Mode:</strong> This edition uses AI-generated speech from news transcripts. Use the controls below to listen to each segment.
                </div>
                
                <!-- TTS Audio Element (hidden, controlled by JS) -->
                <audio id="audio-player" class="w-100 mb-3" controls preload="none" style="display: none;">
                    Your browser does not support the audio element.
                </audio>
                
                <!-- TTS Controls -->
                <div id="tts-controls" class="mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="voice-select" class="form-label">Voice:</label>
                            <select id="voice-select" class="form-select">
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                                <option value="en-AU">English (AU)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="speech-rate" class="form-label">Speech Rate:</label>
                            <select id="speech-rate" class="form-select">
                                <option value="0.5">0.5x (Slow)</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x (Normal)</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x (Fast)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="speech-pitch" class="form-label">Pitch:</label>
                            <select id="speech-pitch" class="form-select">
                                <option value="0.5">Low</option>
                                <option value="1" selected>Normal</option>
                                <option value="1.5">High</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Current Playing Info -->
                <div id="current-playing" class="alert alert-primary d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Now Playing:</strong> <span id="current-segment-title">-</span>
                        </div>
                        <button id="stop-tts" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
                
                <!-- Playback Controls -->
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="play-pause-btn">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="stop-btn">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button type="button" class="btn btn-outline-info" id="replay-btn">
                                <i class="fas fa-redo"></i> Replay
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <label for="speed-control" class="form-label me-2 mb-0">Speed:</label>
                            <select id="speed-control" class="form-select" style="width: auto;">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Time Display -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="current-time" class="text-muted">00:00</span>
                            <span id="duration" class="text-muted">{{ "%.0f"|format(edition.total_duration_sec/60) }}:{{ "%02d"|format(edition.total_duration_sec%60) }}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Segments List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-ol me-2"></i>Content Segments ({{ segments|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if segments %}
                <div class="row">
                    {% for segment in segments %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 segment-card" data-start-time="{{ segment.start_sec }}" data-duration="{{ segment.duration_sec }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">Segment {{ segment.seq }}</h6>
                                    <small class="text-muted">{{ "%.0f"|format(segment.duration_sec/60) }}:{{ "%02d"|format(segment.duration_sec%60) }}</small>
                                </div>
                                
                                <p class="card-text">
                                    {{ segment.transcript_text[:150] if segment.transcript_text else segment.headline }}{% if segment.transcript_text and segment.transcript_text|length > 150 %}...{% endif %}
                                </p>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>Start: {{ "%.0f"|format(segment.start_sec/60) }}:{{ "%02d"|format(segment.start_sec%60) }}
                                    </small>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-primary jump-to-segment" data-time="{{ segment.start_sec }}">
                                        <i class="fas fa-play me-1"></i>Jump to This Segment
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary toggle-transcript" data-target="transcript-{{ segment.id }}">
                                        <i class="fas fa-eye me-1"></i>Show Transcript
                                    </button>
                                </div>
                                
                                <!-- Hidden Transcript -->
                                <div id="transcript-{{ segment.id }}" class="mt-3 p-3 bg-light rounded" style="display: none;">
                                    <small class="text-muted d-block mb-2">Full Transcript:</small>
                                    {{ segment.transcript_text if segment.transcript_text else segment.headline }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>No Segments Available</h4>
                    <p class="text-muted">This edition doesn't have any segments loaded yet. Please try again later.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Practice Instructions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5 class="alert-heading">
                <i class="fas fa-lightbulb me-2"></i>How to Practice
            </h5>
            <ul class="mb-0">
                <li><strong>Listen First:</strong> Play the complete audio without reading transcripts</li>
                <li><strong>Take Notes:</strong> Practice note-taking skills while listening</li>
                <li><strong>Jump to Segments:</strong> Click on specific segments to focus on difficult parts</li>
                <li><strong>Adjust Speed:</strong> Use slower speeds for better comprehension</li>
                <li><strong>Review Transcripts:</strong> Check transcripts after listening to verify understanding</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class DailyEditionTTSPlayer {
    constructor() {
        this.speechSynthesis = window.speechSynthesis;
        this.currentUtterance = null;
        this.isPlaying = false;
        this.currentSegmentIndex = 0;
        this.segments = [];
        this.voices = [];
        
        this.initializePlayer();
        this.loadVoices();
    }
    
    initializePlayer() {
        // Collect all segments data
        document.querySelectorAll('.segment-card').forEach((card, index) => {
            const transcriptId = card.querySelector('.toggle-transcript').dataset.target;
            const transcriptElement = document.getElementById(transcriptId);
            const text = transcriptElement ? transcriptElement.textContent.trim() : '';
            
            this.segments.push({
                index: index,
                element: card,
                text: text,
                title: card.querySelector('.card-title').textContent,
                startTime: parseFloat(card.dataset.startTime) || 0,
                duration: parseFloat(card.dataset.duration) || 0
            });
        });
        
        console.log(`Loaded ${this.segments.length} segments for TTS`);
    }
    
    loadVoices() {
        const updateVoices = () => {
            this.voices = this.speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voice-select');
            
            // Clear existing options
            voiceSelect.innerHTML = '';
            
            // Filter English voices
            const englishVoices = this.voices.filter(voice => 
                voice.lang.startsWith('en')
            );
            
            if (englishVoices.length > 0) {
                englishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            } else {
                // Fallback options
                const fallbackOptions = [
                    { value: 'default', text: 'Default Voice' }
                ];
                fallbackOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    voiceSelect.appendChild(option);
                });
            }
        };
        
        // Load voices
        updateVoices();
        this.speechSynthesis.onvoiceschanged = updateVoices;
    }
    
    getSelectedVoice() {
        const voiceSelect = document.getElementById('voice-select');
        const selectedVoiceName = voiceSelect.value;
        return this.voices.find(voice => voice.name === selectedVoiceName) || this.voices[0];
    }
    
    speak(text, segmentTitle = '', onStart = null, onEnd = null) {
        if (this.isPlaying) {
            this.stop();
        }
        
        if (!text || text.trim().length === 0) {
            console.warn('No text to speak');
            return;
        }
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Configure voice settings
        const voice = this.getSelectedVoice();
        if (voice) utterance.voice = voice;
        
        utterance.rate = parseFloat(document.getElementById('speech-rate').value) || 1;
        utterance.pitch = parseFloat(document.getElementById('speech-pitch').value) || 1;
        utterance.volume = 1;
        
        // Event handlers
        utterance.onstart = () => {
            this.isPlaying = true;
            this.currentUtterance = utterance;
            
            // Show current playing info
            const currentPlaying = document.getElementById('current-playing');
            const currentTitle = document.getElementById('current-segment-title');
            currentTitle.textContent = segmentTitle || 'Daily Edition';
            currentPlaying.classList.remove('d-none');
            
            if (onStart) onStart();
        };
        
        utterance.onend = () => {
            this.isPlaying = false;
            this.currentUtterance = null;
            
            // Hide current playing info
            document.getElementById('current-playing').classList.add('d-none');
            
            if (onEnd) onEnd();
        };
        
        utterance.onerror = (event) => {
            console.error('Speech synthesis error:', event);
            this.isPlaying = false;
            this.currentUtterance = null;
            document.getElementById('current-playing').classList.add('d-none');
        };
        
        this.speechSynthesis.speak(utterance);
    }
    
    stop() {
        if (this.isPlaying && this.currentUtterance) {
            this.speechSynthesis.cancel();
            this.isPlaying = false;
            this.currentUtterance = null;
            document.getElementById('current-playing').classList.add('d-none');
        }
    }
    
    playSegment(segmentIndex) {
        if (segmentIndex < 0 || segmentIndex >= this.segments.length) {
            console.warn('Invalid segment index:', segmentIndex);
            return;
        }
        
        const segment = this.segments[segmentIndex];
        this.currentSegmentIndex = segmentIndex;
        
        // Highlight current segment
        this.highlightSegment(segmentIndex);
        
        this.speak(
            segment.text,
            segment.title,
            () => {
                console.log(`Started playing segment ${segmentIndex + 1}: ${segment.title}`);
            },
            () => {
                console.log(`Finished playing segment ${segmentIndex + 1}`);
                this.clearHighlights();
            }
        );
    }
    
    playAllSegments() {
        if (this.segments.length === 0) return;
        
        const playNext = (index) => {
            if (index >= this.segments.length) {
                console.log('Finished playing all segments');
                return;
            }
            
            const segment = this.segments[index];
            this.currentSegmentIndex = index;
            this.highlightSegment(index);
            
            this.speak(
                segment.text,
                `Segment ${index + 1}: ${segment.title}`,
                null,
                () => {
                    this.clearHighlights();
                    // Play next segment after a short pause
                    setTimeout(() => playNext(index + 1), 500);
                }
            );
        };
        
        playNext(0);
    }
    
    highlightSegment(index) {
        this.clearHighlights();
        if (this.segments[index]) {
            this.segments[index].element.classList.add('border-primary', 'bg-light');
        }
    }
    
    clearHighlights() {
        this.segments.forEach(segment => {
            segment.element.classList.remove('border-primary', 'bg-light');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize TTS Player
    const ttsPlayer = new DailyEditionTTSPlayer();
    
    // Update original play/pause button to play all segments
    const playPauseBtn = document.getElementById('play-pause-btn');
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            if (!ttsPlayer.isPlaying) {
                ttsPlayer.playAllSegments();
                this.innerHTML = '<i class="fas fa-pause"></i> Pause';
            } else {
                ttsPlayer.stop();
                this.innerHTML = '<i class="fas fa-play"></i> Play';
            }
        });
    }
    
    // Stop button
    const stopBtn = document.getElementById('stop-btn');
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            ttsPlayer.stop();
            if (playPauseBtn) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
            }
        });
    }
    
    // TTS Stop button
    const stopTTSBtn = document.getElementById('stop-tts');
    if (stopTTSBtn) {
        stopTTSBtn.addEventListener('click', function() {
            ttsPlayer.stop();
            if (playPauseBtn) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
            }
        });
    }
    
    // Replay button
    const replayBtn = document.getElementById('replay-btn');
    if (replayBtn) {
        replayBtn.addEventListener('click', function() {
            ttsPlayer.playAllSegments();
            if (playPauseBtn) {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            }
        });
    }
    
    // Individual segment play buttons
    document.querySelectorAll('.jump-to-segment').forEach((button, index) => {
        button.addEventListener('click', function() {
            const segmentIndex = parseInt(this.closest('.segment-card').querySelector('.card-title').textContent.match(/\d+/)[0]) - 1;
            ttsPlayer.playSegment(segmentIndex);
        });
    });
    
    // Toggle transcript functionality
    document.querySelectorAll('.toggle-transcript').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const transcript = document.getElementById(targetId);
            
            if (transcript.style.display === 'none') {
                transcript.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Transcript';
            } else {
                transcript.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye me-1"></i>Show Transcript';
            }
        });
    });
    
    // Voice settings change handlers
    ['voice-select', 'speech-rate', 'speech-pitch'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                console.log(`Updated ${id}:`, this.value);
            });
        }
    });
});
</script>
{% endblock %}